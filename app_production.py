# Redeploy trigger Feb 4 2026 - Railway syncfrom fastapi import FastAPI, HTTPExceptionfrom fastapi.middleware.cors import CORSMiddlewareimport osimport jsonfrom datetime import datetimeimport psycopg2from psycopg2.extras import RealDictCursorapp = FastAPI(title="VortexAI Backend")# CORS middlewareapp.add_middleware(    CORSMiddleware,    allow_origins=["*"],    allow_credentials=True,    allow_methods=["*"],    allow_headers=["*"],)# Database connectiondef get_db_connection():    try:        conn = psycopg2.connect(os.getenv('DATABASE_URL'))        return conn    except Exception as e:        print(f"Database connection failed: {str(e)}")        return None@app.get("/health")async def health():    return {"status": "ok", "timestamp": datetime.now().isoformat()}@app.post("/admin/webhooks/deal-ingest")async def ingest_deal(data: dict):    """Ingest a single deal from sources"""    try:        conn = get_db_connection()        if not conn:            raise HTTPException(status_code=500, detail="Database connection failed")                cur = conn.cursor()                # Validate required fields        name = data.get('name', 'Unknown')        email = data.get('email', 'unknown@local')        asset_type = data.get('asset_type', 'unknown')        location = data.get('location', 'Unknown')        price = data.get('price')                if not price or price <= 0:            raise HTTPException(status_code=400, detail="Invalid price")                # Insert into deals table        cur.execute("""            INSERT INTO deals (name, email, asset_type, location, price, source, created_at)            VALUES (%s, %s, %s, %s, %s, %s, NOW())            RETURNING id        """, (name, email, asset_type, location, price, data.get('source', 'unknown')))                deal_id = cur.fetchone()[0]        conn.commit()        cur.close()        conn.close()                return {"status": "success", "deal_id": deal_id, "message": "Deal ingested"}    except Exception as e:        return {"status": "error", "message": str(e)}@app.get("/admin/deals")async def get_deals(limit: int = 100, offset: int = 0):    """Get all deals"""    try:        conn = get_db_connection()        if not conn:            raise HTTPException(status_code=500, detail="Database connection failed")                cur = conn.cursor(RealDictCursor)        cur.execute("SELECT * FROM deals ORDER BY created_at DESC LIMIT %s OFFSET %s", (limit, offset))        deals = cur.fetchall()                cur.execute("SELECT COUNT(*) FROM deals")        total = cur.fetchone()[0]                cur.close()        conn.close()                return {            "status": "success",            "total": total,            "limit": limit,            "offset": offset,            "deals": deals        }    except Exception as e:        return {"status": "error", "message": str(e)}if __name__ == "__main__":    import uvicorn    uvicorn.run(app, host="0.0.0.0", port=8080)

