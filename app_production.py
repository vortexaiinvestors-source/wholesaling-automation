#!/usr/bin/env python3import osimport jsonfrom datetime import datetimefrom fastapi import FastAPI, HTTPExceptionfrom fastapi.middleware.cors import CORSMiddlewareimport psycopg2from psycopg2.extras import RealDictCursorapp = FastAPI(title="VortexAI", version="1.0")# CORSapp.add_middleware(    CORSMiddleware,    allow_origins=["*"],    allow_credentials=True,    allow_methods=["*"],    allow_headers=["*"],)# Database connectionDATABASE_URL = os.getenv('DATABASE_URL')def get_db_connection():    return psycopg2.connect(DATABASE_URL)@app.get("/health")def health():    return {"status": "ok", "timestamp": datetime.utcnow().isoformat()}@app.post("/admin/webhooks/deal-ingest")def ingest_deal(data: dict):    """Ingest a single deal"""    try:        conn = get_db_connection()        cur = conn.cursor()                name = data.get('name', 'Unknown')        email = data.get('email', 'unknown@local')        asset_type = data.get('asset_type', 'real_estate')        location = data.get('location', 'Unknown')        price = float(data.get('price', 0))                # Insert into deals table        cur.execute("""            INSERT INTO deals (name, email, asset_type, location, price, created_at)            VALUES (%s, %s, %s, %s, %s, %s)            RETURNING id        """, (name, email, asset_type, location, price, datetime.utcnow()))                deal_id = cur.fetchone()[0]        conn.commit()        cur.close()        conn.close()                return {"status": "success", "deal_id": deal_id, "message": "Deal ingested"}    except Exception as e:        raise HTTPException(status_code=500, detail=str(e))@app.get("/admin/deals")def get_deals(limit: int = 100, offset: int = 0):    """Get deals from database"""    try:        conn = get_db_connection()        cur = conn.cursor(RealDictCursor)                cur.execute("""            SELECT id, name, email, asset_type, location, price, created_at            FROM deals            ORDER BY created_at DESC            LIMIT %s OFFSET %s        """, (limit, offset))                deals = cur.fetchall()                cur.execute("SELECT COUNT(*) FROM deals")        total = cur.fetchone()[0]                cur.close()        conn.close()                return {"deals": deals, "total": total, "limit": limit, "offset": offset}    except Exception as e:        raise HTTPException(status_code=500, detail=str(e))@app.get("/api/buyers")def get_buyers():    """Get buyers"""    return {"buyers": [], "message": "No buyers configured yet"}@app.post("/api/commissions/track")def track_commission(deal_id: int, amount: float, percentage: float):    """Track commission on closed deal"""    return {"status": "success", "deal_id": deal_id, "amount": amount, "percentage": percentage}if __name__ == "__main__":    import uvicorn    uvicorn.run(app, host="0.0.0.0", port=8080)
